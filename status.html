<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œê²° í˜„í™© - ê´‘ì˜ì—¬ê³  ì•„ì¹¨ììŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-normal { @apply bg-green-100 text-green-800; }
        .status-partial { @apply bg-yellow-100 text-yellow-800; }
        .status-missing { @apply bg-red-100 text-red-800; }
        .status-processed { @apply bg-blue-100 text-blue-800; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- í—¤ë” -->
    <header class="gradient-bg shadow-lg">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white mb-1">
                        <i class="fas fa-chart-line mr-2"></i>ì‹¤ì‹œê°„ ì¶œê²° í˜„í™©
                    </h1>
                    <p class="text-indigo-100">ê´‘ì˜ì—¬ìê³ ë“±í•™êµ ì•„ì¹¨ììŠµ</p>
                </div>
                <div class="text-right text-white">
                    <div class="text-lg font-semibold" id="current-date"></div>
                    <div class="text-sm text-indigo-200" id="current-time"></div>
                    <div class="flex items-center justify-end mt-2">
                        <span class="w-2 h-2 bg-green-400 rounded-full pulse-dot mr-1" id="status-indicator"></span>
                        <span class="text-xs" id="status-text">ì—°ê²° í™•ì¸ ì¤‘...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- ë¹ ë¥¸ í†µê³„ -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <!-- ì „ì²´ ì¶œì„ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">ì „ì²´ ì¶œì„</h3>
                        <p class="text-2xl font-bold text-gray-900" id="total-count">0</p>
                    </div>
                </div>
            </div>

            <!-- ì •ìƒ ì™„ë£Œ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">ì •ìƒ ì™„ë£Œ</h3>
                        <p class="text-2xl font-bold text-gray-900" id="completed-count">0</p>
                    </div>
                </div>
            </div>

            <!-- ì§„í–‰ ì¤‘ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">ì§„í–‰ ì¤‘</h3>
                        <p class="text-2xl font-bold text-gray-900" id="ongoing-count">0</p>
                    </div>
                </div>
            </div>

            <!-- ëˆ„ë½/ë¬¸ì œ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">ëˆ„ë½/ë¬¸ì œ</h3>
                        <p class="text-2xl font-bold text-gray-900" id="missing-count">0</p>
                    </div>
                </div>
            </div>

            <!-- ğŸ†• ì´ í•™ìŠµì‹œê°„ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-stopwatch text-purple-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">ì´ í•™ìŠµì‹œê°„</h3>
                        <p class="text-lg font-bold text-gray-900" id="total-study-time">0ì‹œê°„</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•„í„° ë° ê²€ìƒ‰ -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                        <select id="date-filter" class="border border-gray-300 rounded-md px-3 py-2">
                            <option value="">ì „ì²´ ë‚ ì§œ</option>
                            <option value="today">ì˜¤ëŠ˜</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                        <select id="status-filter" class="border border-gray-300 rounded-md px-3 py-2">
                            <option value="">ì „ì²´</option>
                            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                            <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                            <option value="ëˆ„ë½">ëˆ„ë½</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="í•™ë²ˆ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰..." 
                            class="border border-gray-300 rounded-md pl-10 pr-4 py-2 w-64"
                        >
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <button onclick="refreshData()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md">
                        <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
        </div>

        <!-- ì¶œê²° í˜„í™© í…Œì´ë¸” -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-table mr-2 text-indigo-600"></i>
                    ì¶œê²° í˜„í™© ëª©ë¡
                </h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚ ì§œ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í•™ë²ˆ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì´ë¦„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì…ì‹¤ì‹œê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í‡´ì‹¤ì‹œê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í•™ìŠµì‹œê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table" class="bg-white divide-y divide-gray-200">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ë°ì´í„° -->
                    </tbody>
                </table>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div id="empty-state" class="hidden text-center py-12">
                <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-700 mb-2">ì¶œê²° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p class="text-gray-500 mb-6">ì•„ë˜ ë°©ë²•ìœ¼ë¡œ ì¶œê²° ë°ì´í„°ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”:</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-lg mx-auto">
                    <a href="admin.html" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-colors">
                        <i class="fas fa-cloud-download-alt mr-2"></i>Google Sheetsì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    </a>
                    
                    <a href="index.html" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition-colors">
                        <i class="fas fa-plus mr-2"></i>ì§ì ‘ ì¶œê²° ì…ë ¥í•˜ê¸°
                    </a>
                </div>
                
                <div class="mt-8 text-sm text-gray-400">
                    <p>ğŸ’¡ <strong>ì¶”ì²œ:</strong> admin í˜ì´ì§€ì—ì„œ "ì „ì²´ ê¸°ì¡´ ë°ì´í„° í•œë²ˆì— ê°€ì ¸ì˜¤ê¸°"ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”</p>
                </div>
            </div>
        </div>

        <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="index.html" class="bg-white border border-gray-200 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-plus-circle text-2xl text-indigo-600 mb-2"></i>
                <h3 class="font-medium text-gray-900">ì¶œê²° ì…ë ¥</h3>
                <p class="text-sm text-gray-500">ìƒˆë¡œìš´ ì¶œê²° ê¸°ë¡</p>
            </a>
            
            <a href="admin.html" class="bg-white border border-gray-200 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-cogs text-2xl text-purple-600 mb-2"></i>
                <h3 class="font-medium text-gray-900">ê´€ë¦¬ì ë©”ë‰´</h3>
                <p class="text-sm text-gray-500">ë°ì´í„° ê´€ë¦¬ ë° ì„¤ì •</p>
            </a>
            
            <button onclick="exportData()" class="bg-white border border-gray-200 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-download text-2xl text-green-600 mb-2"></i>
                <h3 class="font-medium text-gray-900">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                <p class="text-sm text-gray-500">Excel íŒŒì¼ë¡œ ì €ì¥</p>
            </button>
        </div>
    </main>

    <!-- API ëª¨ë“ˆ ë¡œë“œ -->
    <script src="js/api.js"></script>
    
    <script>
        // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateDateTime() {
            const now = new Date();
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('ko-KR', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'long' 
                });
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('ko-KR');
        }

        updateDateTime();
        setInterval(updateDateTime, 1000);

        // ğŸ†• ë‚ ì§œ í•„í„° ì´ˆê¸°í™” (ì „ì²´ê°€ ê¸°ë³¸ê°’)
        document.getElementById('date-filter').value = '';

        // ì¶œê²° ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ  
        async function loadAttendanceData() {
            // ğŸ”§ ë°ì´í„° ë¡œë“œ ì „ì— í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ í•œë²ˆ ë” ì‹¤í–‰
            cleanupTestData();
            
            const selectedDateOption = document.getElementById('date-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            // ë‚ ì§œ í•„í„° ê°’ ì²˜ë¦¬
            let selectedDate = null;
            if (selectedDateOption === 'today') {
                selectedDate = new Date().toISOString().split('T')[0];
            } else if (selectedDateOption) {
                selectedDate = selectedDateOption;
            }
            // ë¹ˆ ê°’('') ë˜ëŠ” 'all'ì´ë©´ selectedDate = null (ì „ì²´)

            console.log('ğŸ“Š status.htmlì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„:', selectedDateOption, 'â†’', selectedDate);
            
            // ğŸ†• ì§ì ‘ Google Sheets ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œë„
            let allData = [];
            
            try {
                console.log('ğŸ“¡ ì§ì ‘ Google Apps Script í˜¸ì¶œ...');
                const googleResponse = await fetch('https://script.google.com/macros/s/AKfycbxBZekl8Dx9LGDHCEz9_-U8Mm5R0Qo0aj3VJWOxgavIPE1KGF8KWJR17Wf9BdcrDKsT/exec?action=getAllAttendance');
                
                if (googleResponse.ok) {
                    const googleResult = await googleResponse.json();
                    console.log('ğŸ“Š Google Sheets ì§ì ‘ ì¡°íšŒ ê²°ê³¼:', googleResult);
                    
                    if (googleResult.success && googleResult.data) {
                        // Google Sheets ë°ì´í„°ë¥¼ ì›¹ì‹œìŠ¤í…œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                        googleResult.data.forEach(googleRecord => {
                            // ì…ì‹¤ ê¸°ë¡ ìƒì„±
                            if (googleRecord.checkInTime) {
                                const baseDate = typeof googleRecord.date === 'string' ? 
                                    googleRecord.date : 
                                    new Date(googleRecord.date).toISOString().split('T')[0];
                                
                                const checkInDateTime = new Date(`${baseDate}T${googleRecord.checkInTime}`);
                                
                                if (!isNaN(checkInDateTime.getTime())) {
                                    allData.push({
                                        id: `${googleRecord.id}-checkin`,
                                        studentId: googleRecord.studentId,
                                        studentName: googleRecord.studentName,
                                        status: 'ì…ì‹¤',
                                        timestamp: checkInDateTime.toISOString(),
                                        source: 'google_sheets'
                                    });
                                }
                            }
                            
                            // í‡´ì‹¤ ê¸°ë¡ ìƒì„±
                            if (googleRecord.checkOutTime) {
                                const baseDate = typeof googleRecord.date === 'string' ? 
                                    googleRecord.date : 
                                    new Date(googleRecord.date).toISOString().split('T')[0];
                                
                                const checkOutDateTime = new Date(`${baseDate}T${googleRecord.checkOutTime}`);
                                
                                if (!isNaN(checkOutDateTime.getTime())) {
                                    allData.push({
                                        id: `${googleRecord.id}-checkout`,
                                        studentId: googleRecord.studentId,
                                        studentName: googleRecord.studentName,
                                        status: 'í‡´ì‹¤',
                                        timestamp: checkOutDateTime.toISOString(),
                                        source: 'google_sheets'
                                    });
                                }
                            }
                        });
                        
                        console.log(`ğŸ“Š Google Sheetsì—ì„œ ë³€í™˜ëœ ë°ì´í„°: ${allData.length}ê±´`);
                    }
                }
            } catch (googleError) {
                console.warn('Google Sheets ì§ì ‘ ì¡°íšŒ ì‹¤íŒ¨:', googleError);
            }
            
            // ë¡œì»¬ ë°ì´í„°ë„ ì¶”ê°€
            try {
                const localData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                console.log(`ğŸ“Š ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë°ì´í„°: ${localData.length}ê±´`);
                
                // ğŸ†• ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ adminì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„° í™•ì¸
                if (localData.length === 0) {
                    console.log('ğŸ” admin í˜ì´ì§€ì—ì„œ ì €ì¥ëœ ë°ì´í„° í™•ì¸ ì¤‘...');
                    
                    // admin í˜ì´ì§€ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                    const keys = Object.keys(localStorage);
                    console.log('ğŸ“‹ í˜„ì¬ localStorage í‚¤ë“¤:', keys);
                    
                    // ğŸ†• localStorageì—ì„œ ë‹¤ë¥¸ í‚¤ë¡œ ì €ì¥ëœ ë°ì´í„°ë„ í™•ì¸
                    console.log('ğŸ” ëª¨ë“  localStorage ë°ì´í„° í™•ì¸ ì¤‘...');
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        console.log(`ğŸ“¦ localStorage[${key}]:`, value ? value.substring(0, 100) + '...' : 'null');
                    }
                    
                    // ğŸ†• ì‹¤ì œ ë°ì´í„°ë§Œ ì‚¬ìš© (í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì•ˆ í•¨)
                    const adminData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                    const realData = adminData.filter(item => item.source !== 'test_data');
                    
                    if (realData.length > 0) {
                        console.log('âœ… ì‹¤ì œ ë°ì´í„° ë°œê²¬:', realData.length + 'ê±´');
                        allData = allData.concat(realData);
                    } else {
                        console.log('ğŸ“­ ì‹¤ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¹ˆ ìƒíƒœë¡œ í‘œì‹œí•©ë‹ˆë‹¤.');
                        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±í•˜ì§€ ì•ŠìŒ - ë¹ˆ ìƒíƒœ ìœ ì§€
                    }
                } else {
                    allData = allData.concat(localData);
                }
            } catch (localError) {
                console.warn('ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', localError);
            }
            
            console.log(`ğŸ“Š ì´ ë°ì´í„°: ${allData.length}ê±´`);
            
            if (allData.length === 0) {
                console.log('ğŸ“­ í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                document.getElementById('attendance-table').innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                updateStatistics([]);
                return;
            } else {
                console.log('âœ… ë°ì´í„°ê°€ ìˆìŒ, UI ì—…ë°ì´íŠ¸ ì‹œì‘');
                // ë¹ˆ ìƒíƒœ ìˆ¨ê¸°ê¸°
                document.getElementById('empty-state').classList.add('hidden');
                
                // ğŸ†• ë‚ ì§œ ì˜µì…˜ ë™ì  ìƒì„±
                updateDateFilterOptions(allData);
            }

            // ğŸ†• ë‚ ì§œ í•„í„°ë§ (nullì´ë©´ ì „ì²´, ê°’ì´ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œë§Œ)
            let filteredData = allData;
            if (selectedDate) {
                filteredData = allData.filter(record => {
                    const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                    return recordDate === selectedDate;
                });
                console.log(`ğŸ“… ${selectedDate} í•„í„°ë§ ê²°ê³¼: ${filteredData.length}ê±´`);
            } else {
                console.log('ğŸ“… ì „ì²´ ë‚ ì§œ í‘œì‹œ:', filteredData.length + 'ê±´');
            }
            
            // ê²€ìƒ‰ í•„í„°ë§
            if (searchTerm) {
                filteredData = filteredData.filter(record => {
                    return record.studentId.toLowerCase().includes(searchTerm) || 
                           record.studentName.toLowerCase().includes(searchTerm);
                });
            }
            
            console.log(`ğŸ“Š í•„í„°ë§ í›„ ë°ì´í„°: ${filteredData.length}ê±´`);

            // ğŸ†• ë‚ ì§œë³„ í•™ìƒ ë°ì´í„° ì§‘ê³„ (ë‚ ì§œë³„ë¡œ ë¶„ë¦¬)
            const dateStudentData = createDateStudentData(filteredData);
            
            // í†µê³„ìš© í•™ìƒë³„ ë°ì´í„° (ê¸°ì¡´ ë°©ì‹ - í†µê³„ìš©)
            const studentData = {};
            filteredData.forEach(record => {
                const key = record.studentId;
                if (!studentData[key]) {
                    studentData[key] = {
                        studentId: record.studentId,
                        studentName: record.studentName,
                        checkIn: null,
                        checkOut: null,
                        records: []
                    };
                }
                
                studentData[key].records.push(record);
                
                if (record.status === 'ì…ì‹¤') {
                    const checkTime = new Date(record.timestamp);
                    if (!studentData[key].checkIn || checkTime < new Date(studentData[key].checkIn.timestamp)) {
                        studentData[key].checkIn = record;
                    }
                } else if (record.status === 'í‡´ì‹¤') {
                    const checkTime = new Date(record.timestamp);
                    if (!studentData[key].checkOut || checkTime > new Date(studentData[key].checkOut.timestamp)) {
                        studentData[key].checkOut = record;
                    }
                }
            });

            // í†µê³„ ì—…ë°ì´íŠ¸
            const students = Object.values(studentData);
            console.log(`ğŸ‘¥ ì§‘ê³„ëœ í•™ìƒ ìˆ˜: ${students.length}ëª…`);
            console.log('ğŸ‘¥ í•™ìƒ ë°ì´í„° ìƒ˜í”Œ:', students[0]);
            
            updateStatistics(students);
            console.log('ğŸ“Š í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');

            // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ë‚ ì§œë³„ ë°ì´í„° ì‚¬ìš©)
            updateAttendanceTable(dateStudentData, statusFilter);
            console.log('ğŸ“‹ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics(studentData) {
            console.log('ğŸ“Š í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘, í•™ìƒ ìˆ˜:', studentData.length);
            
            const total = studentData.length;
            let completed = 0;
            let ongoing = 0;
            let missing = 0;

            studentData.forEach(student => {
                console.log(`ğŸ‘¤ ${student.studentName}: ì…ì‹¤=${!!student.checkIn}, í‡´ì‹¤=${!!student.checkOut}`);
                if (student.checkIn && student.checkOut) {
                    completed++;
                } else if (student.checkIn && !student.checkOut) {
                    ongoing++;
                } else {
                    missing++;
                }
            });

            console.log(`ğŸ“Š í†µê³„: ì „ì²´=${total}, ì™„ë£Œ=${completed}, ì§„í–‰=${ongoing}, ëˆ„ë½=${missing}`);

            // DOM ì—˜ë¦¬ë¨¼íŠ¸ ì¡´ì¬ í™•ì¸ ë° ì—…ë°ì´íŠ¸
            const totalElement = document.getElementById('total-count');
            const completedElement = document.getElementById('completed-count');
            const ongoingElement = document.getElementById('ongoing-count');
            const missingElement = document.getElementById('missing-count');

            if (totalElement) {
                totalElement.textContent = total;
                console.log('âœ… total-count ì—…ë°ì´íŠ¸:', total);
            } else {
                console.error('âŒ total-count ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }

            if (completedElement) {
                completedElement.textContent = completed;
                console.log('âœ… completed-count ì—…ë°ì´íŠ¸:', completed);
            } else {
                console.error('âŒ completed-count ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }

            if (ongoingElement) {
                ongoingElement.textContent = ongoing;
                console.log('âœ… ongoing-count ì—…ë°ì´íŠ¸:', ongoing);
            } else {
                console.error('âŒ ongoing-count ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }

            if (missingElement) {
                missingElement.textContent = missing;
                console.log('âœ… missing-count ì—…ë°ì´íŠ¸:', missing);
            } else {
                console.error('âŒ missing-count ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            }
        }

        // ğŸ†• ë‚ ì§œë³„ í•™ìƒ ë°ì´í„° ìƒì„± (ê°œì„ ëœ ë²„ì „)
        function createDateStudentData(filteredData) {
            const dateStudentMap = {};
            
            // ë‚ ì§œë³„ë¡œ í•™ìƒ ë°ì´í„° ê·¸ë£¹í™”
            filteredData.forEach(record => {
                const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                const key = `${recordDate}_${record.studentId}`;
                
                if (!dateStudentMap[key]) {
                    dateStudentMap[key] = {
                        date: recordDate,
                        studentId: record.studentId,
                        studentName: record.studentName,
                        checkIn: null,
                        checkOut: null,
                        records: []
                    };
                }
                
                dateStudentMap[key].records.push(record);
                
                if (record.status === 'ì…ì‹¤') {
                    const checkTime = new Date(record.timestamp);
                    if (!dateStudentMap[key].checkIn || checkTime < new Date(dateStudentMap[key].checkIn.timestamp)) {
                        dateStudentMap[key].checkIn = record;
                    }
                } else if (record.status === 'í‡´ì‹¤') {
                    const checkTime = new Date(record.timestamp);
                    if (!dateStudentMap[key].checkOut || checkTime > new Date(dateStudentMap[key].checkOut.timestamp)) {
                        dateStudentMap[key].checkOut = record;
                    }
                }
            });
            
            return Object.values(dateStudentMap);
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸ (ë‚ ì§œë³„ ì •ë ¬)
        function updateAttendanceTable(studentData, statusFilter) {
            console.log('ğŸ“‹ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì‹œì‘, ë°ì´í„°:', studentData.length + 'ê±´');
            
            const tableBody = document.getElementById('attendance-table');
            const emptyState = document.getElementById('empty-state');

            if (studentData.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // ìƒíƒœë³„ í•„í„°ë§
            const filteredStudents = studentData.filter(student => {
                if (!statusFilter) return true;
                
                const status = getStudentStatus(student);
                return status.includes(statusFilter);
            });

            // ğŸ†• ë‚ ì§œë³„ ì •ë ¬ (ìµœì‹  ë‚ ì§œ ë¨¼ì €)
            filteredStudents.sort((a, b) => {
                const dateA = a.date || (a.checkIn ? new Date(a.checkIn.timestamp).toISOString().split('T')[0] : '0000-00-00');
                const dateB = b.date || (b.checkIn ? new Date(b.checkIn.timestamp).toISOString().split('T')[0] : '0000-00-00');
                return dateB.localeCompare(dateA);
            });

            // ğŸ†• ì´ í•™ìŠµì‹œê°„ ê³„ì‚°
            let totalMinutes = 0;
            
            tableBody.innerHTML = filteredStudents.map(student => {
                const date = student.date || (student.checkIn ? new Date(student.checkIn.timestamp).toLocaleDateString('ko-KR') : '-');
                const checkInTime = student.checkIn ? formatTime(student.checkIn.timestamp) : '-';
                const checkOutTime = student.checkOut ? formatTime(student.checkOut.timestamp) : '-';
                const studyTime = calculateStudyTime(student.checkIn, student.checkOut);
                const status = getStudentStatus(student);
                const statusBadge = getStatusBadge(status);

                // í•™ìŠµì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜í•´ì„œ ì´í•©ì— ì¶”ê°€
                if (student.checkIn && student.checkOut) {
                    const start = new Date(student.checkIn.timestamp);
                    const end = new Date(student.checkOut.timestamp);
                    const diffMs = end - start;
                    const diffMins = Math.floor(diffMs / (1000 * 60));
                    if (diffMins > 0 && diffMins <= 1440) { // 0ë¶„~24ì‹œê°„ ì‚¬ì´ë§Œ
                        totalMinutes += diffMins;
                    }
                }

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">${student.studentId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkInTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkOutTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${studyTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    </tr>
                `;
            }).join('');

            // ğŸ†• ì´ í•™ìŠµì‹œê°„ í‘œì‹œ
            updateTotalStudyTime(totalMinutes);
            console.log('ğŸ“Š ì´ í•™ìŠµì‹œê°„:', totalMinutes + 'ë¶„');
        }

        // ğŸ†• ì´ í•™ìŠµì‹œê°„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateTotalStudyTime(totalMinutes) {
            const element = document.getElementById('total-study-time');
            if (!element) return;
            
            if (totalMinutes <= 0) {
                element.textContent = '0ì‹œê°„';
                return;
            }
            
            const totalHours = Math.floor(totalMinutes / 60);
            const remainingMins = totalMinutes % 60;
            
            if (totalHours > 0) {
                if (remainingMins > 0) {
                    element.textContent = `${totalHours}ì‹œê°„ ${remainingMins}ë¶„`;
                } else {
                    element.textContent = `${totalHours}ì‹œê°„`;
                }
            } else {
                element.textContent = `${remainingMins}ë¶„`;
            }
        }

        // ğŸ†• ë‚ ì§œ í•„í„° ì˜µì…˜ ë™ì  ìƒì„±
        function updateDateFilterOptions(allData) {
            const dateFilter = document.getElementById('date-filter');
            const currentValue = dateFilter.value;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
            while (dateFilter.children.length > 2) {
                dateFilter.removeChild(dateFilter.lastChild);
            }
            
            // ë°ì´í„°ì—ì„œ ê³ ìœ í•œ ë‚ ì§œ ì¶”ì¶œ
            const dates = new Set();
            allData.forEach(record => {
                const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                dates.add(recordDate);
            });
            
            // ë‚ ì§œ ì •ë ¬ (ìµœì‹ ìˆœ)
            const sortedDates = Array.from(dates).sort((a, b) => b.localeCompare(a));
            
            // ì˜µì…˜ ì¶”ê°€
            sortedDates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = new Date(date + 'T00:00:00').toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                });
                dateFilter.appendChild(option);
            });
            
            // ì´ì „ ê°’ ë³µì›
            dateFilter.value = currentValue;
            
            console.log('ğŸ“… ë‚ ì§œ ì˜µì…˜ ì—…ë°ì´íŠ¸:', sortedDates.length + 'ê°œ ë‚ ì§œ');
        }

        // í•™ìƒ ìƒíƒœ ê³„ì‚°
        function getStudentStatus(student) {
            if (student.checkIn && student.checkOut) {
                return 'ì™„ë£Œ';
            } else if (student.checkIn && !student.checkOut) {
                return 'ì§„í–‰ì¤‘';
            } else {
                return 'ëˆ„ë½';
            }
        }

        // ìƒíƒœ ë°°ì§€ ìƒì„±
        function getStatusBadge(status) {
            const badgeClasses = {
                'ì™„ë£Œ': 'status-badge status-normal',
                'ì§„í–‰ì¤‘': 'status-badge status-partial', 
                'ëˆ„ë½': 'status-badge status-missing'
            };

            const icons = {
                'ì™„ë£Œ': 'fas fa-check-circle',
                'ì§„í–‰ì¤‘': 'fas fa-clock',
                'ëˆ„ë½': 'fas fa-exclamation-triangle'
            };

            return `<span class="${badgeClasses[status]}">
                <i class="${icons[status]} mr-1"></i>${status}
            </span>`;
        }

        // í•™ìŠµì‹œê°„ ê³„ì‚° (ìˆ˜ì •ëœ ë²„ì „)
        function calculateStudyTime(checkIn, checkOut) {
            if (!checkIn || !checkOut) return '-';
            
            console.log('ğŸ• í•™ìŠµì‹œê°„ ê³„ì‚°:', {
                checkIn: checkIn.timestamp,
                checkOut: checkOut.timestamp,
                checkInName: checkIn.studentName
            });
            
            const start = new Date(checkIn.timestamp);
            const end = new Date(checkOut.timestamp);
            
            // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                console.warn('âš ï¸ ì˜ëª»ëœ ë‚ ì§œ í˜•ì‹:', { start, end });
                return 'ì˜¤ë¥˜';
            }
            
            const diffMs = end - start;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            console.log('ğŸ• ì‹œê°„ ì°¨ì´:', {
                diffMs: diffMs,
                diffMins: diffMins,
                hours: Math.floor(diffMins / 60)
            });
            
            // ìŒìˆ˜ì´ê±°ë‚˜ 24ì‹œê°„ ì´ìƒì´ë©´ ì˜¤ë¥˜
            if (diffMins <= 0) return 'ì…ì‹¤ í›„ í‡´ì‹¤';
            if (diffMins > 1440) { // 24ì‹œê°„ = 1440ë¶„
                console.warn('âš ï¸ ë¹„ì •ìƒì ìœ¼ë¡œ ê¸´ í•™ìŠµì‹œê°„:', diffMins + 'ë¶„');
                return 'ê³„ì‚°ì˜¤ë¥˜';
            }
            
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            
            if (hours > 0) {
                return `${hours}ì‹œê°„ ${mins}ë¶„`;
            } else {
                return `${mins}ë¶„`;
            }
        }

        // ì‹œê°„ í¬ë§·íŒ…
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // í•™ìƒ ë¹„ê³ ì‚¬í•­
        function getStudentNotes(student) {
            const notes = [];
            
            if (student.checkIn) {
                const checkInTime = new Date(student.checkIn.timestamp);
                const hour = checkInTime.getHours();
                
                if (hour >= 8) {
                    notes.push('ì§€ê° ì…ì‹¤');
                } else if (hour < 5) {
                    notes.push('ì‹œê°„ì™¸ ì…ì‹¤');
                }
            }
            
            if (student.checkOut) {
                const checkOutTime = new Date(student.checkOut.timestamp);
                const hour = checkOutTime.getHours();
                const minute = checkOutTime.getMinutes();
                
                if (hour > 7 || (hour === 7 && minute > 50)) {
                    notes.push('ëŠ¦ì€ í‡´ì‹¤');
                }
            }
            
            return notes.length > 0 ? notes.join(', ') : '-';
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshData() {
            await loadAttendanceData();
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportData() {
            try {
                const result = window.attendanceAPI.exportData('csv');
                if (result.success) {
                    alert(result.message);
                }
            } catch (error) {
                alert(error.message);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('date-filter').addEventListener('change', loadAttendanceData);
        document.getElementById('status-filter').addEventListener('change', loadAttendanceData);
        document.getElementById('search-input').addEventListener('input', loadAttendanceData);

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateConnectionStatus() {
            try {
                // APIê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (typeof window.attendanceAPI === 'undefined') {
                    const indicator = document.getElementById('status-indicator');
                    const text = document.getElementById('status-text');
                    indicator.className = 'w-2 h-2 bg-yellow-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'API ë¡œë”© ì¤‘...';
                    return;
                }

                const status = await window.attendanceAPI.checkConnection();
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                
                console.log('ğŸ” ì—°ê²° ìƒíƒœ ì²´í¬ ê²°ê³¼:', status);
                
                if (status.connected === true) {
                    indicator.className = 'w-2 h-2 bg-green-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'Google Sheets ì—°ë™';
                } else if (status.connected === 'unknown') {
                    indicator.className = 'w-2 h-2 bg-blue-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ';
                } else {
                    indicator.className = 'w-2 h-2 bg-yellow-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'ë¡œì»¬ ëª¨ë“œ';
                }
            } catch (error) {
                console.warn('ì—°ê²° ìƒíƒœ ì²´í¬ ì˜¤ë¥˜:', error);
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                
                // ë” ìƒì„¸í•œ ìƒíƒœ í‘œì‹œ
                if (error.message && error.message.includes('fetch')) {
                    indicator.className = 'w-2 h-2 bg-blue-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ';
                } else {
                    indicator.className = 'w-2 h-2 bg-green-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'ë¡œì»¬ ì‹œìŠ¤í…œ ì‘ë™';
                }
            }
        }

        // API ë¡œë“œ ëŒ€ê¸° ë° ì´ˆê¸°í™”
        function initializeApp() {
            console.log('ğŸš€ ì•± ì´ˆê¸°í™” ì‹œì‘...');
            console.log('ğŸ” window.attendanceAPI ì¡´ì¬ ì—¬ë¶€:', typeof window.attendanceAPI);
            
            if (typeof window.attendanceAPI === 'undefined') {
                console.log('â³ API ë¡œë”© ëŒ€ê¸° ì¤‘...');
                // APIê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 10ì´ˆ)
                let attempts = 0;
                const checkAPI = setInterval(() => {
                    attempts++;
                    console.log(`ğŸ” API ì²´í¬ ì‹œë„ ${attempts}/20`);
                    
                    if (typeof window.attendanceAPI !== 'undefined') {
                        console.log('âœ… API ë¡œë“œ ì™„ë£Œ!');
                        clearInterval(checkAPI);
                        startApp();
                    } else if (attempts >= 20) {
                        console.log('âŒ API ë¡œë“œ ì‹¤íŒ¨, ì§ì ‘ ëª¨ë“œë¡œ ì „í™˜');
                        clearInterval(checkAPI);
                        startAppWithoutAPI();
                    }
                }, 500);
            } else {
                console.log('âœ… API ì´ë¯¸ ë¡œë“œë¨');
                startApp();
            }
        }

        // API ì‚¬ìš© ëª¨ë“œë¡œ ì‹œì‘
        function startApp() {
            console.log('ğŸ¯ API ëª¨ë“œë¡œ ì•± ì‹œì‘');
            loadAttendanceData();
            updateConnectionStatus();

            // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (30ì´ˆë§ˆë‹¤)
            setInterval(() => {
                loadAttendanceData();
                updateConnectionStatus();
            }, 30000);
        }

        // API ì—†ì´ ì§ì ‘ ëª¨ë“œë¡œ ì‹œì‘
        function startAppWithoutAPI() {
            console.log('ğŸ¯ ì§ì ‘ ëª¨ë“œë¡œ ì•± ì‹œì‘');
            
            // ì—°ê²° ìƒíƒœë¥¼ ë¡œì»¬ ëª¨ë“œë¡œ ì„¤ì •
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            indicator.className = 'w-2 h-2 bg-yellow-400 rounded-full pulse-dot mr-1';
            text.textContent = 'ì§ì ‘ ëª¨ë“œ';
            
            // ì§ì ‘ ë°ì´í„° ë¡œë“œ
            loadAttendanceDataDirect();
        }

        // API ì—†ì´ ì§ì ‘ ë°ì´í„° ë¡œë“œ
        async function loadAttendanceDataDirect() {
            console.log('ğŸ“Š ì§ì ‘ ëª¨ë“œë¡œ ë°ì´í„° ë¡œë“œ');
            
            // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
            const testData = [
                {
                    id: 'test1',
                    studentId: '12345',
                    studentName: 'ê¹€ê´‘ì˜',
                    status: 'ì…ì‹¤',
                    timestamp: '2025-09-27T06:30:00.000Z',
                    source: 'test_data'
                },
                {
                    id: 'test2', 
                    studentId: '12345',
                    studentName: 'ê¹€ê´‘ì˜', 
                    status: 'í‡´ì‹¤',
                    timestamp: '2025-09-27T07:45:00.000Z',
                    source: 'test_data'
                },
                {
                    id: 'test3',
                    studentId: '23456',
                    studentName: 'ë°•ì˜í¬',
                    status: 'ì…ì‹¤',
                    timestamp: '2025-09-27T06:25:00.000Z', 
                    source: 'test_data'
                }
            ];
            
            console.log('ğŸ“Š í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±:', testData.length + 'ê±´');
            
            // í•™ìƒë³„ ë°ì´í„° ì§‘ê³„
            const studentData = {};
            testData.forEach(record => {
                const key = record.studentId;
                if (!studentData[key]) {
                    studentData[key] = {
                        studentId: record.studentId,
                        studentName: record.studentName,
                        checkIn: null,
                        checkOut: null,
                        records: []
                    };
                }
                
                studentData[key].records.push(record);
                
                if (record.status === 'ì…ì‹¤') {
                    studentData[key].checkIn = record;
                } else if (record.status === 'í‡´ì‹¤') {
                    studentData[key].checkOut = record;
                }
            });

            // í†µê³„ ë° í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateStatistics(Object.values(studentData));
            updateAttendanceTable(Object.values(studentData), '');
        }

        // ğŸ†• localStorage ë³€í™” ê°ì§€ (adminì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¬ ë•Œ)
        window.addEventListener('storage', function(e) {
            if (e.key === 'attendanceData') {
                console.log('ğŸ“¡ localStorage ë³€í™” ê°ì§€! ë°ì´í„° ìƒˆë¡œê³ ì¹¨...');
                cleanupTestData(); // ì •ë¦¬ ë¨¼ì €
                setTimeout(() => loadAttendanceData(), 100);
            }
        });

        // ğŸ†• ê°™ì€ í˜ì´ì§€ ë‚´ì—ì„œ localStorage ë³€í™” ê°ì§€
        const originalSetItem = localStorage.setItem;
        localStorage.setItem = function(key, value) {
            originalSetItem.call(this, key, value);
            if (key === 'attendanceData') {
                console.log('ğŸ“¡ attendanceData ì—…ë°ì´íŠ¸ ê°ì§€!');
                cleanupTestData(); // ì •ë¦¬ ë¨¼ì €
                setTimeout(() => loadAttendanceData(), 200);
            }
        };

        // ğŸ§¹ ê°•ë ¥í•œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬
        function cleanupTestData() {
            try {
                const allData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                
                // ë” í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° ê°ì§€
                const testData = allData.filter(item => 
                    item.source === 'test_data' || 
                    item.studentName === 'ê¹€ê´‘ì˜' || 
                    item.studentName === 'ë°•ì˜í¬' ||
                    item.studentId === '12345' ||
                    item.studentId === '23456'
                );
                
                const realData = allData.filter(item => 
                    item.source !== 'test_data' && 
                    item.studentName !== 'ê¹€ê´‘ì˜' && 
                    item.studentName !== 'ë°•ì˜í¬' &&
                    item.studentId !== '12345' &&
                    item.studentId !== '23456'
                );
                
                if (testData.length > 0) {
                    console.log('ğŸ§¹ í…ŒìŠ¤íŠ¸ ë°ì´í„° ê°•ë ¥ ì •ë¦¬:', testData.length + 'ê±´');
                    console.log('ğŸ§¹ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„¸:', testData);
                    
                    localStorage.setItem('attendanceData', JSON.stringify(realData));
                    console.log('âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ, ì‹¤ì œ ë°ì´í„°:', realData.length + 'ê±´');
                    
                    // ì •ë¦¬ ê²°ê³¼ ê°•ì œ ì €ì¥ í™•ì¸
                    const verification = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                    console.log('ğŸ” ì •ë¦¬ í›„ ê²€ì¦:', verification.length + 'ê±´');
                    
                    return true; // ì •ë¦¬í–ˆìŒì„ ì•Œë¦¼
                } else {
                    console.log('âœ… ì •ë¦¬í•  í…ŒìŠ¤íŠ¸ ë°ì´í„° ì—†ìŒ');
                    return false; // ì •ë¦¬í•  ê²Œ ì—†ì—ˆìŒì„ ì•Œë¦¼
                }
            } catch (error) {
                console.error('âŒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ');
            
            // ğŸ†— URL íŒŒë¼ë¯¸í„°ë¡œ ê°•ì œ ì •ë¦¬ ëª¨ë“œ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const forceClean = urlParams.get('clean') === 'true';
            
            if (forceClean) {
                console.log('ğŸ§¹ ê°•ì œ ì •ë¦¬ ëª¨ë“œ ì‹¤í–‰');
                localStorage.removeItem('attendanceData');
                console.log('âœ… ê°•ì œ ì •ë¦¬ ì™„ë£Œ');
            }
            
            // ğŸ”§ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ë¥¼ ë¨¼ì € ì‹¤í–‰
            const wasCleanedUp = cleanupTestData();
            
            if (wasCleanedUp || forceClean) {
                console.log('ğŸ”„ í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì •ë¦¬ë˜ì—ˆìœ¼ë¯€ë¡œ ì ì‹œ í›„ ì¬ì´ˆê¸°í™”');
                // ì •ë¦¬ê°€ ëœ ê²½ìš° ë” ê¸´ ì‹œê°„ ëŒ€ê¸°
                setTimeout(initializeApp, 500);
            } else {
                console.log('âœ… ì •ë¦¬í•  ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ë°”ë¡œ ì´ˆê¸°í™”');
                // ì •ë¦¬í•  ê²Œ ì—†ì—ˆìœ¼ë©´ ë°”ë¡œ ì´ˆê¸°í™”
                setTimeout(initializeApp, 100);
            }
        });

        // API ìŠ¤í¬ë¦½íŠ¸ê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°ë¥¼ ìœ„í•œ fallback
        setTimeout(() => {
            console.log('ğŸ”„ fallback ì´ˆê¸°í™” ì‹¤í–‰');
            cleanupTestData(); // fallbackì—ì„œë„ ì •ë¦¬ ë¨¼ì €
            setTimeout(initializeApp, 100);
        }, 1000); // 1ì´ˆ í›„ ê°•ì œ ì´ˆê¸°í™”

        // ğŸ†• í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œì—ë„ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì´ë™í•´ì˜¬ ë•Œ)
        window.addEventListener('focus', function() {
            console.log('ğŸ‘€ í˜ì´ì§€ í¬ì»¤ìŠ¤ ê°ì§€ - í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬');
            const wasCleanedUp = cleanupTestData();
            if (wasCleanedUp) {
                console.log('ğŸ”„ í¬ì»¤ìŠ¤ ì‹œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ë¨, ë°ì´í„° ì¬ë¡œë“œ');
                setTimeout(() => loadAttendanceData(), 200);
            } else {
                setTimeout(() => loadAttendanceData(), 50);
            }
        });

        // ğŸ†• í˜ì´ì§€ ê°€ì‹œì„± ë³€í™” ê°ì§€ (ë¸Œë¼ìš°ì € íƒ­ ì „í™˜ ë“±)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('ğŸ‘€ í˜ì´ì§€ ê°€ì‹œì„± ë³µêµ¬ - í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬');
                const wasCleanedUp = cleanupTestData();
                if (wasCleanedUp) {
                    console.log('ğŸ”„ ê°€ì‹œì„± ë³µêµ¬ ì‹œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ë¨, ë°ì´í„° ì¬ë¡œë“œ');
                    setTimeout(() => loadAttendanceData(), 200);
                } else {
                    setTimeout(() => loadAttendanceData(), 50);
                }
            }
        });
    </script>
</body>
</html>

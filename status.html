<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œê²° í˜„í™© - ê´‘ì˜ì—¬ê³  ì•„ì¹¨ììŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-normal { @apply bg-green-100 text-green-800; }
        .status-partial { @apply bg-yellow-100 text-yellow-800; }
        .status-missing { @apply bg-red-100 text-red-800; }
        .status-processed { @apply bg-blue-100 text-blue-800; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- í—¤ë” -->
    <header class="gradient-bg shadow-lg">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white mb-1">
                        <i class="fas fa-chart-line mr-2"></i>ì‹¤ì‹œê°„ ì¶œê²° í˜„í™©
                    </h1>
                    <p class="text-indigo-100">ê´‘ì˜ì—¬ìê³ ë“±í•™êµ ì•„ì¹¨ììŠµ</p>
                </div>
                <div class="text-right text-white">
                    <div class="text-lg font-semibold" id="current-date"></div>
                    <div class="text-sm text-indigo-200" id="current-time"></div>
                    <div class="flex items-center justify-end mt-2">
                        <span class="w-2 h-2 bg-green-400 rounded-full pulse-dot mr-1" id="status-indicator"></span>
                        <span class="text-xs" id="status-text">ì—°ê²° í™•ì¸ ì¤‘...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- ë¹ ë¥¸ í†µê³„ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- ì „ì²´ ì¶œì„ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">ì „ì²´ ì¶œì„</h3>
                        <p class="text-2xl font-bold text-gray-900" id="total-count">0</p>
                    </div>
                </div>
            </div>

            <!-- ì •ìƒ ì™„ë£Œ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">ì •ìƒ ì™„ë£Œ</h3>
                        <p class="text-2xl font-bold text-gray-900" id="completed-count">0</p>
                    </div>
                </div>
            </div>

            <!-- ì§„í–‰ ì¤‘ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">ì§„í–‰ ì¤‘</h3>
                        <p class="text-2xl font-bold text-gray-900" id="ongoing-count">0</p>
                    </div>
                </div>
            </div>

            <!-- ëˆ„ë½/ë¬¸ì œ -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500">ëˆ„ë½/ë¬¸ì œ</h3>
                        <p class="text-2xl font-bold text-gray-900" id="missing-count">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•„í„° ë° ê²€ìƒ‰ -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ë‚ ì§œ</label>
                        <input type="date" id="date-filter" class="border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ìƒíƒœ</label>
                        <select id="status-filter" class="border border-gray-300 rounded-md px-3 py-2">
                            <option value="">ì „ì²´</option>
                            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                            <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                            <option value="ëˆ„ë½">ëˆ„ë½</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="í•™ë²ˆ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰..." 
                            class="border border-gray-300 rounded-md pl-10 pr-4 py-2 w-64"
                        >
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <button onclick="refreshData()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md">
                        <i class="fas fa-sync-alt mr-1"></i>ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
        </div>

        <!-- ì¶œê²° í˜„í™© í…Œì´ë¸” -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-table mr-2 text-indigo-600"></i>
                    ì¶œê²° í˜„í™© ëª©ë¡
                </h2>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í•™ë²ˆ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì´ë¦„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì…ì‹¤ì‹œê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í‡´ì‹¤ì‹œê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í•™ìŠµì‹œê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table" class="bg-white divide-y divide-gray-200">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ë°ì´í„° -->
                    </tbody>
                </table>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div id="empty-state" class="hidden text-center py-12">
                <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                <p class="text-gray-500">ì•„ì§ ì¶œê²° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <a href="index.html" class="inline-block mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md">
                    <i class="fas fa-plus mr-1"></i>ì¶œê²° ì…ë ¥í•˜ê¸°
                </a>
            </div>
        </div>

        <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
            <a href="index.html" class="bg-white border border-gray-200 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-plus-circle text-2xl text-indigo-600 mb-2"></i>
                <h3 class="font-medium text-gray-900">ì¶œê²° ì…ë ¥</h3>
                <p class="text-sm text-gray-500">ìƒˆë¡œìš´ ì¶œê²° ê¸°ë¡</p>
            </a>
            
            <a href="admin.html" class="bg-white border border-gray-200 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-cogs text-2xl text-purple-600 mb-2"></i>
                <h3 class="font-medium text-gray-900">ê´€ë¦¬ì ë©”ë‰´</h3>
                <p class="text-sm text-gray-500">ë°ì´í„° ê´€ë¦¬ ë° ì„¤ì •</p>
            </a>
            
            <button onclick="exportData()" class="bg-white border border-gray-200 rounded-lg p-4 text-center hover:bg-gray-50 transition-colors">
                <i class="fas fa-download text-2xl text-green-600 mb-2"></i>
                <h3 class="font-medium text-gray-900">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h3>
                <p class="text-sm text-gray-500">Excel íŒŒì¼ë¡œ ì €ì¥</p>
            </button>
        </div>
    </main>

    <!-- API ëª¨ë“ˆ ë¡œë“œ -->
    <script src="js/api.js"></script>
    
    <script>
        // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateDateTime() {
            const now = new Date();
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('ko-KR', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'long' 
                });
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('ko-KR');
        }

        updateDateTime();
        setInterval(updateDateTime, 1000);

        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        document.getElementById('date-filter').valueAsDate = new Date();

        // ì¶œê²° ë°ì´í„° ë¡œë“œ ë° í‘œì‹œ  
        async function loadAttendanceData() {
            const selectedDate = document.getElementById('date-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            console.log('ğŸ“Š status.htmlì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„:', selectedDate);
            
            // ğŸ†• ì§ì ‘ Google Sheets ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œë„
            let allData = [];
            
            try {
                console.log('ğŸ“¡ ì§ì ‘ Google Apps Script í˜¸ì¶œ...');
                const googleResponse = await fetch('https://script.google.com/macros/s/AKfycbxBZekl8Dx9LGDHCEz9_-U8Mm5R0Qo0aj3VJWOxgavIPE1KGF8KWJR17Wf9BdcrDKsT/exec?action=getAllAttendance');
                
                if (googleResponse.ok) {
                    const googleResult = await googleResponse.json();
                    console.log('ğŸ“Š Google Sheets ì§ì ‘ ì¡°íšŒ ê²°ê³¼:', googleResult);
                    
                    if (googleResult.success && googleResult.data) {
                        // Google Sheets ë°ì´í„°ë¥¼ ì›¹ì‹œìŠ¤í…œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                        googleResult.data.forEach(googleRecord => {
                            // ì…ì‹¤ ê¸°ë¡ ìƒì„±
                            if (googleRecord.checkInTime) {
                                const baseDate = typeof googleRecord.date === 'string' ? 
                                    googleRecord.date : 
                                    new Date(googleRecord.date).toISOString().split('T')[0];
                                
                                const checkInDateTime = new Date(`${baseDate}T${googleRecord.checkInTime}`);
                                
                                if (!isNaN(checkInDateTime.getTime())) {
                                    allData.push({
                                        id: `${googleRecord.id}-checkin`,
                                        studentId: googleRecord.studentId,
                                        studentName: googleRecord.studentName,
                                        status: 'ì…ì‹¤',
                                        timestamp: checkInDateTime.toISOString(),
                                        source: 'google_sheets'
                                    });
                                }
                            }
                            
                            // í‡´ì‹¤ ê¸°ë¡ ìƒì„±
                            if (googleRecord.checkOutTime) {
                                const baseDate = typeof googleRecord.date === 'string' ? 
                                    googleRecord.date : 
                                    new Date(googleRecord.date).toISOString().split('T')[0];
                                
                                const checkOutDateTime = new Date(`${baseDate}T${googleRecord.checkOutTime}`);
                                
                                if (!isNaN(checkOutDateTime.getTime())) {
                                    allData.push({
                                        id: `${googleRecord.id}-checkout`,
                                        studentId: googleRecord.studentId,
                                        studentName: googleRecord.studentName,
                                        status: 'í‡´ì‹¤',
                                        timestamp: checkOutDateTime.toISOString(),
                                        source: 'google_sheets'
                                    });
                                }
                            }
                        });
                        
                        console.log(`ğŸ“Š Google Sheetsì—ì„œ ë³€í™˜ëœ ë°ì´í„°: ${allData.length}ê±´`);
                    }
                }
            } catch (googleError) {
                console.warn('Google Sheets ì§ì ‘ ì¡°íšŒ ì‹¤íŒ¨:', googleError);
            }
            
            // ë¡œì»¬ ë°ì´í„°ë„ ì¶”ê°€
            try {
                const localData = JSON.parse(localStorage.getItem('attendanceData') || '[]');
                console.log(`ğŸ“Š ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë°ì´í„°: ${localData.length}ê±´`);
                
                // ğŸ†• ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ adminì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„° í™•ì¸
                if (localData.length === 0) {
                    console.log('ğŸ” admin í˜ì´ì§€ì—ì„œ ì €ì¥ëœ ë°ì´í„° í™•ì¸ ì¤‘...');
                    
                    // admin í˜ì´ì§€ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
                    const keys = Object.keys(localStorage);
                    console.log('ğŸ“‹ í˜„ì¬ localStorage í‚¤ë“¤:', keys);
                    
                    // í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„° ìƒì„± (admin ë°ì´í„°ê°€ ì—†ì„ ë•Œ)
                    if (localData.length === 0) {
                        console.log('ğŸ“ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì¤‘...');
                        const testData = [
                            {
                                id: 'test1',
                                studentId: '12345',
                                studentName: 'ê¹€ê´‘ì˜',
                                status: 'ì…ì‹¤',
                                timestamp: '2025-09-27T06:30:00.000Z',
                                source: 'test_data'
                            },
                            {
                                id: 'test2',
                                studentId: '12345', 
                                studentName: 'ê¹€ê´‘ì˜',
                                status: 'í‡´ì‹¤',
                                timestamp: '2025-09-27T07:45:00.000Z',
                                source: 'test_data'
                            },
                            {
                                id: 'test3',
                                studentId: '23456',
                                studentName: 'ë°•ì˜í¬',
                                status: 'ì…ì‹¤', 
                                timestamp: '2025-09-27T06:25:00.000Z',
                                source: 'test_data'
                            }
                        ];
                        
                        allData = allData.concat(testData);
                        console.log('ğŸ¯ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€ë¨:', testData.length + 'ê±´');
                    }
                } else {
                    allData = allData.concat(localData);
                }
            } catch (localError) {
                console.warn('ë¡œì»¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', localError);
            }
            
            console.log(`ğŸ“Š ì´ ë°ì´í„°: ${allData.length}ê±´`);
            
            if (allData.length === 0) {
                console.log('ğŸ“­ í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                document.getElementById('attendance-table').innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                updateStatistics([]);
                return;
            }

            // ë‚ ì§œ í•„í„°ë§
            let filteredData = allData;
            if (selectedDate) {
                filteredData = allData.filter(record => {
                    const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                    return recordDate === selectedDate;
                });
            }
            
            // ê²€ìƒ‰ í•„í„°ë§
            if (searchTerm) {
                filteredData = filteredData.filter(record => {
                    return record.studentId.toLowerCase().includes(searchTerm) || 
                           record.studentName.toLowerCase().includes(searchTerm);
                });
            }
            
            console.log(`ğŸ“Š í•„í„°ë§ í›„ ë°ì´í„°: ${filteredData.length}ê±´`);

            // í•™ìƒë³„ ë°ì´í„° ì§‘ê³„
            const studentData = {};
            filteredData.forEach(record => {
                const key = record.studentId;
                if (!studentData[key]) {
                    studentData[key] = {
                        studentId: record.studentId,
                        studentName: record.studentName,
                        checkIn: null,
                        checkOut: null,
                        records: []
                    };
                }
                
                studentData[key].records.push(record);
                
                if (record.status === 'ì…ì‹¤') {
                    const checkTime = new Date(record.timestamp);
                    if (!studentData[key].checkIn || checkTime < new Date(studentData[key].checkIn.timestamp)) {
                        studentData[key].checkIn = record;
                    }
                } else if (record.status === 'í‡´ì‹¤') {
                    const checkTime = new Date(record.timestamp);
                    if (!studentData[key].checkOut || checkTime > new Date(studentData[key].checkOut.timestamp)) {
                        studentData[key].checkOut = record;
                    }
                }
            });

            // í†µê³„ ì—…ë°ì´íŠ¸
            updateStatistics(Object.values(studentData));

            // í…Œì´ë¸” ì—…ë°ì´íŠ¸
            updateAttendanceTable(Object.values(studentData), statusFilter);
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics(studentData) {
            const total = studentData.length;
            let completed = 0;
            let ongoing = 0;
            let missing = 0;

            studentData.forEach(student => {
                if (student.checkIn && student.checkOut) {
                    completed++;
                } else if (student.checkIn && !student.checkOut) {
                    ongoing++;
                } else {
                    missing++;
                }
            });

            document.getElementById('total-count').textContent = total;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('ongoing-count').textContent = ongoing;
            document.getElementById('missing-count').textContent = missing;
        }

        // í…Œì´ë¸” ì—…ë°ì´íŠ¸
        function updateAttendanceTable(studentData, statusFilter) {
            const tableBody = document.getElementById('attendance-table');
            const emptyState = document.getElementById('empty-state');

            if (studentData.length === 0) {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            // ìƒíƒœë³„ í•„í„°ë§
            const filteredStudents = studentData.filter(student => {
                if (!statusFilter) return true;
                
                const status = getStudentStatus(student);
                return status.includes(statusFilter);
            });

            tableBody.innerHTML = filteredStudents.map(student => {
                const checkInTime = student.checkIn ? formatTime(student.checkIn.timestamp) : '-';
                const checkOutTime = student.checkOut ? formatTime(student.checkOut.timestamp) : '-';
                const studyTime = calculateStudyTime(student.checkIn, student.checkOut);
                const status = getStudentStatus(student);
                const statusBadge = getStatusBadge(status);
                const notes = getStudentNotes(student);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">${student.studentId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.studentName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkInTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${checkOutTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${studyTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${notes}</td>
                    </tr>
                `;
            }).join('');
        }

        // í•™ìƒ ìƒíƒœ ê³„ì‚°
        function getStudentStatus(student) {
            if (student.checkIn && student.checkOut) {
                return 'ì™„ë£Œ';
            } else if (student.checkIn && !student.checkOut) {
                return 'ì§„í–‰ì¤‘';
            } else {
                return 'ëˆ„ë½';
            }
        }

        // ìƒíƒœ ë°°ì§€ ìƒì„±
        function getStatusBadge(status) {
            const badgeClasses = {
                'ì™„ë£Œ': 'status-badge status-normal',
                'ì§„í–‰ì¤‘': 'status-badge status-partial', 
                'ëˆ„ë½': 'status-badge status-missing'
            };

            const icons = {
                'ì™„ë£Œ': 'fas fa-check-circle',
                'ì§„í–‰ì¤‘': 'fas fa-clock',
                'ëˆ„ë½': 'fas fa-exclamation-triangle'
            };

            return `<span class="${badgeClasses[status]}">
                <i class="${icons[status]} mr-1"></i>${status}
            </span>`;
        }

        // í•™ìŠµì‹œê°„ ê³„ì‚°
        function calculateStudyTime(checkIn, checkOut) {
            if (!checkIn || !checkOut) return '-';
            
            const start = new Date(checkIn.timestamp);
            const end = new Date(checkOut.timestamp);
            const diffMs = end - start;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffMins <= 0) return 'ì˜¤ë¥˜';
            
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            
            if (hours > 0) {
                return `${hours}ì‹œê°„ ${mins}ë¶„`;
            } else {
                return `${mins}ë¶„`;
            }
        }

        // ì‹œê°„ í¬ë§·íŒ…
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // í•™ìƒ ë¹„ê³ ì‚¬í•­
        function getStudentNotes(student) {
            const notes = [];
            
            if (student.checkIn) {
                const checkInTime = new Date(student.checkIn.timestamp);
                const hour = checkInTime.getHours();
                
                if (hour >= 8) {
                    notes.push('ì§€ê° ì…ì‹¤');
                } else if (hour < 5) {
                    notes.push('ì‹œê°„ì™¸ ì…ì‹¤');
                }
            }
            
            if (student.checkOut) {
                const checkOutTime = new Date(student.checkOut.timestamp);
                const hour = checkOutTime.getHours();
                const minute = checkOutTime.getMinutes();
                
                if (hour > 7 || (hour === 7 && minute > 50)) {
                    notes.push('ëŠ¦ì€ í‡´ì‹¤');
                }
            }
            
            return notes.length > 0 ? notes.join(', ') : '-';
        }

        // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        async function refreshData() {
            await loadAttendanceData();
        }

        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportData() {
            try {
                const result = window.attendanceAPI.exportData('csv');
                if (result.success) {
                    alert(result.message);
                }
            } catch (error) {
                alert(error.message);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('date-filter').addEventListener('change', loadAttendanceData);
        document.getElementById('status-filter').addEventListener('change', loadAttendanceData);
        document.getElementById('search-input').addEventListener('input', loadAttendanceData);

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateConnectionStatus() {
            try {
                // APIê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (typeof window.attendanceAPI === 'undefined') {
                    const indicator = document.getElementById('status-indicator');
                    const text = document.getElementById('status-text');
                    indicator.className = 'w-2 h-2 bg-yellow-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'API ë¡œë”© ì¤‘...';
                    return;
                }

                const status = await window.attendanceAPI.checkConnection();
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                
                console.log('ğŸ” ì—°ê²° ìƒíƒœ ì²´í¬ ê²°ê³¼:', status);
                
                if (status.connected === true) {
                    indicator.className = 'w-2 h-2 bg-green-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'Google Sheets ì—°ë™';
                } else if (status.connected === 'unknown') {
                    indicator.className = 'w-2 h-2 bg-blue-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ';
                } else {
                    indicator.className = 'w-2 h-2 bg-yellow-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'ë¡œì»¬ ëª¨ë“œ';
                }
            } catch (error) {
                console.warn('ì—°ê²° ìƒíƒœ ì²´í¬ ì˜¤ë¥˜:', error);
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                
                // ë” ìƒì„¸í•œ ìƒíƒœ í‘œì‹œ
                if (error.message && error.message.includes('fetch')) {
                    indicator.className = 'w-2 h-2 bg-blue-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ';
                } else {
                    indicator.className = 'w-2 h-2 bg-green-400 rounded-full pulse-dot mr-1';
                    text.textContent = 'ë¡œì»¬ ì‹œìŠ¤í…œ ì‘ë™';
                }
            }
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadAttendanceData();
        updateConnectionStatus();

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (30ì´ˆë§ˆë‹¤)
        setInterval(() => {
            loadAttendanceData();
            updateConnectionStatus();
        }, 30000);
    </script>
</body>
</html>
